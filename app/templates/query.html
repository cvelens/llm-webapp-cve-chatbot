{% extends "base.html" %}

{% block title %}Query - CVE Query System{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-history">
        <h3>Chat History</h3>
        <ul id="history-list">
            {% for query in history %}
            <li>{{ query.query }}</li>
            {% endfor %}
        </ul>
    </div>
    <div class="chat-main">
        <div id="chat-messages">
            {% for query in history %}
    <div class="ai-message">{{ query.response|replace('\n', '<br>')|safe }}</div>
    <div class="user-message">{{ query.query|replace('\n', '<br>')|safe }}</div>
            {% endfor %}
        </div>        
        <form id="query-form" method="POST">
            <textarea id="query" name="query" rows="3" placeholder="Enter your query here..." required></textarea>
            <button type="submit" class="btn">Send</button>
        </form>
    </div>
</div>

<script>
document.getElementById('query-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var queryText = document.getElementById('query').value.trim();
    
    if (queryText) {
        fetch('/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: 'query=' + encodeURIComponent(queryText)
        })
        .then(response => response.json())
        .then(data => {
            if (data.response && data.query) {
                var chatMessages = document.getElementById('chat-messages');
                
                // Convert newlines to <br> tags
                var formattedResponse = data.response.replace(/\n/g, '<br>');
                var formattedQuery = data.query.replace(/\n/g, '<br>');

                chatMessages.innerHTML = '<div class="ai-message">' + formattedResponse + '</div>' +
                         '<div class="user-message">' + formattedQuery + '</div>' +
                         chatMessages.innerHTML;

                document.getElementById('query').value = '';

                var historyList = document.getElementById('history-list');
                historyList.innerHTML = '<li>' + formattedQuery + '</li>' + historyList.innerHTML;
            }
        })
        .catch(error => console.error('Error:', error));
    }
});

</script>
{% endblock %}